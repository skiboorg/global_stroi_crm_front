"use strict";(globalThis["webpackChunkglobal_stroi_crm_front"]=globalThis["webpackChunkglobal_stroi_crm_front"]||[]).push([[816],{8550:(e,l,a)=>{a.d(l,{Z:()=>i});var t=a(9835);const o={__name:"AddButton",props:["label","icon","loading","color"],setup(e){return(l,a)=>{const o=(0,t.up)("q-btn");return l.auth.user.role?.permission?.can_add?((0,t.wg)(),(0,t.j4)(o,{key:0,"no-caps":"",unelevated:"",loading:e.loading,color:e.color?e.color:"primary",label:e.label,icon:e.icon?e.icon:"add"},null,8,["loading","color","label","icon"])):(0,t.kq)("",!0)}}};var n=a(8879),u=a(9984),s=a.n(u);const d=o,i=d;s()(o,"components",{QBtn:n.Z})},8203:(e,l,a)=>{a.d(l,{Z:()=>c});var t=a(9835);function o(e,l){const a=(0,t.up)("q-btn");return(0,t.wg)(),(0,t.j4)(a,{"no-caps":"",outline:"",color:"primary",label:"Назад",icon:"arrow_back",class:"q-mr-md",onClick:l[0]||(l[0]=l=>e.$router.back())})}var n=a(1639),u=a(8879),s=a(9984),d=a.n(s);const i={},r=(0,n.Z)(i,[["render",o]]),c=r;d()(i,"components",{QBtn:u.Z})},8227:(e,l,a)=>{a.d(l,{Z:()=>v});var t=a(9835),o=a(499);const n={__name:"DeleteButton",props:["label","icon","loading","color"],emits:["confirm"],setup(e,{emit:l}){const a=(0,o.iH)(!1);return(l,o)=>{const n=(0,t.up)("q-btn"),u=(0,t.up)("q-card-section"),s=(0,t.up)("q-card-actions"),d=(0,t.up)("q-card"),i=(0,t.up)("q-dialog"),r=(0,t.Q2)("close-popup");return(0,t.wg)(),(0,t.iD)(t.HY,null,[l.auth.user.role?.permission?.can_add?((0,t.wg)(),(0,t.j4)(n,{key:0,"no-caps":"",unelevated:"",dense:"",loading:e.loading,color:e.color?e.color:"negative",label:e.label,onClick:o[0]||(o[0]=e=>a.value=!0),icon:e.icon?e.icon:"delete"},null,8,["loading","color","label","icon"])):(0,t.kq)("",!0),(0,t.Wm)(i,{modelValue:a.value,"onUpdate:modelValue":o[2]||(o[2]=e=>a.value=e)},{default:(0,t.w5)((()=>[(0,t.Wm)(d,{style:{width:"300px","max-width":"100vw"}},{default:(0,t.w5)((()=>[(0,t.Wm)(u,{class:"text-center text-bold"},{default:(0,t.w5)((()=>[(0,t.Uk)(" Вы уверены? ")])),_:1}),(0,t.Wm)(s,{align:"center"},{default:(0,t.w5)((()=>[(0,t.wy)((0,t.Wm)(n,{color:"negative",unelevated:"","no-caps":"",label:"Да",onClick:o[1]||(o[1]=e=>l.$emit("confirm"))},null,512),[[r]]),(0,t.wy)((0,t.Wm)(n,{color:"positive",unelevated:"","no-caps":"",label:"Нет"},null,512),[[r]])])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}};var u=a(8879),s=a(2074),d=a(4458),i=a(3190),r=a(1821),c=a(2146),_=a(9984),m=a.n(_);const p=n,v=p;m()(n,"components",{QBtn:u.Z,QDialog:s.Z,QCard:d.Z,QCardSection:i.Z,QCardActions:r.Z}),m()(n,"directives",{ClosePopup:c.Z})},1862:(e,l,a)=>{a.d(l,{Z:()=>i});var t=a(9835);const o={__name:"EditButton",props:["label","icon","color"],setup(e){return(l,a)=>{const o=(0,t.up)("q-btn");return l.auth.user.role?.permission?.can_edit?((0,t.wg)(),(0,t.j4)(o,{key:0,"no-caps":"",unelevated:"",color:e.color,label:e.label,icon:e.icon?e.icon:"edit"},null,8,["color","label","icon"])):(0,t.kq)("",!0)}}};var n=a(8879),u=a(9984),s=a.n(u);const d=o,i=d;s()(o,"components",{QBtn:n.Z})},1816:(e,l,a)=>{a.r(l),a.d(l,{default:()=>oe});a(2879);var t=a(9835),o=a(6970),n=a(499),u=a(1569),s=a(8339),d=a(8550),i=a(1862),r=a(6928),c=a(8203),_=a(8227);const m={key:0,class:"q-mb-md"},p={class:"flex items-center justify-between q-mb-md"},v={class:"no-margin text-h6 text-bold"},b=(0,t._)("p",{class:"text-h6 text-bold"},"Общие данные",-1),w={class:"info-table q-mb-lg"},g=(0,t._)("td",null,[(0,t._)("span",{class:"text-bold"},"Адрес ")],-1),k=(0,t._)("td",null,[(0,t._)("span",{class:"text-bold"},"Подрядчик ")],-1),y=(0,t._)("td",null,[(0,t._)("span",{class:"text-bold"},"Сумма договора ")],-1),f=(0,t._)("td",null,[(0,t._)("span",{class:"text-bold"},"Сумма аванса ")],-1),q=(0,t._)("td",null,[(0,t._)("span",{class:"text-bold"},"Выполнено работ ")],-1),h=(0,t._)("td",null,[(0,t._)("span",{class:"text-bold"},"Сумма к оплате ")],-1),D={class:"q-gutter-md q-mb-md"},V=(0,t._)("p",{class:"text-h6 text-bold"},"Расчет стоимости",-1),C={class:"flex items-start no-wrap"},Z={class:"table q-mb-md"},x={style:{height:"118px"},class:"table-head-row"},j=(0,t._)("td",null,"Наименование товаров",-1),U=(0,t._)("td",null,"Ед. изм",-1),z=(0,t._)("td",null,"Общее кол-во",-1),W=(0,t._)("td",null,"Остаток на сегодня",-1),Q=(0,t._)("td",null,"Цена едн.работы",-1),H=(0,t._)("td",null,"Общая стоимость",-1),S={key:0},B={key:0},L={class:"table-row"},$=(0,t._)("td",{colspan:"4"},null,-1),F=(0,t._)("td",{class:"text-bold"},"Итого",-1),P={class:"text-bold"},Y={class:"table-wrapper"},K={class:"flex items-start no-wrap"},T={class:"table"},A={class:"table-head-row"},I={colspan:"4"},E=(0,t._)("tr",{class:"table-subhead-row"},[(0,t._)("td",null,"План"),(0,t._)("td",null,"Факт"),(0,t._)("td",null,"Сумма к оплате")],-1),G={key:0},J={key:1},M=(0,t._)("br",null,null,-1),N={__name:"object",setup(e){const l=(0,r.t)(),a=(0,n.iH)({}),N=(0,n.iH)([]),O=(0,n.iH)([]),R=(0,n.iH)(!1),X=(0,n.iH)(!1),ee=(0,n.iH)({date:(new Date).toLocaleDateString(),total_done_work_percent:0,total_to_pay:0,items:[],is_new:!0}),le=(0,s.yj)(),ae=(0,n.iH)(!1),te=["м.","шт","уп.","усл."];(0,t.wF)((async()=>{await oe()}));const oe=async()=>{const e=await(0,u.api)(`/api/catalog/object/${le.params.id}?full=true`);a.value=e.data,N.value=a.value.items,O.value=a.value.dates},ne=(0,t.Fl)((()=>{let e=!0,l=!0;for(let a of N.value){if(0===a.total_amount){e=!1;break}if(0===a.price_per_unit){l=!1;break}}return e&&l})),ue=async()=>{await u.api.post("/api/catalog/object/save_table",a.value);await oe(),X.value=!1},se=async()=>{await u.api.post("/api/catalog/object/update_table",a.value);await oe(),ae.value=!1},de=async e=>{N.value[e].is_new?(console.log("new"),N.value.splice(e,1)):(console.log("old"),await u.api.delete(`/api/catalog/object_item/${N.value[e].id}`),await oe())},ie=()=>{X.value=!0,N.value.push({is_new:!0,name:null,unit:null,total_amount:0,today_ostatok:0,price_per_unit:0,total_price:0})},re=()=>{for(let e of O.value)if(new Date(e.date).toLocaleDateString()===(new Date).toLocaleDateString())return;O.value.push(ee.value),R.value=!0;for(let e of N.value)ee.value.items.push({plan_amount:0,fact_amount:0,done_work_percent:0,to_pay:0,item:e.id})};return(e,u)=>{const s=(0,t.up)("q-input"),r=(0,t.up)("q-select"),ee=(0,t.up)("q-btn"),le=(0,t.up)("q-page");return(0,t.wg)(),(0,t.j4)(le,{padding:""},{default:(0,t.w5)((()=>[a.value.id?((0,t.wg)(),(0,t.iD)("div",m,[(0,t._)("div",p,[(0,t.Wm)(c.Z),(0,t._)("p",v,"Объект ID:"+(0,o.zw)(a.value.id)+" - "+(0,o.zw)(a.value.name),1)]),b,(0,t._)("table",w,[(0,t._)("tr",null,[g,(0,t._)("td",null,(0,o.zw)(a.value.address),1)]),(0,t._)("tr",null,[k,(0,t._)("td",null,(0,o.zw)(a.value.subworker?.fio),1)]),(0,t._)("tr",null,[y,(0,t._)("td",null,(0,o.zw)(e.$filters.formatPrice(a.value.total))+" руб",1)]),(0,t._)("tr",null,[f,(0,t._)("td",null,(0,o.zw)(e.$filters.formatPrice(a.value.avans))+" руб",1)]),(0,t._)("tr",null,[q,(0,t._)("td",null,(0,o.zw)(a.value.procent_done)+" %",1)]),(0,t._)("tr",null,[h,(0,t._)("td",null,(0,o.zw)(e.$filters.formatPrice(a.value.to_pay))+" руб",1)])])])):(0,t.kq)("",!0),(0,t._)("div",D,[a.value.is_items_added&&a.value.items?.length>0&&!R.value?((0,t.wg)(),(0,t.j4)(i.Z,{key:0,class:"q-mb-md",label:"Редактировать таблицу",color:"warning",onClick:u[0]||(u[0]=e=>ae.value=!0)})):(0,t.kq)("",!0),a.value.is_items_added&&a.value.items?.length>0&&!R.value&&!ae.value?((0,t.wg)(),(0,t.j4)(d.Z,{key:1,class:"q-mb-md",label:"Добавить дату",color:"positive",onClick:re})):(0,t.kq)("",!0)]),V,(0,t._)("div",C,[(0,t._)("table",Z,[(0,t._)("tr",x,[j,U,z,W,Q,H,0===a.value.dates?.length?((0,t.wg)(),(0,t.iD)("td",S)):(0,t.kq)("",!0)]),((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(N.value,((e,l)=>((0,t.wg)(),(0,t.iD)("tr",{class:"table-row",key:l},[(0,t._)("td",null,[(0,t.Wm)(s,{readonly:!ae.value&&!e.is_new,dense:"",standout:"",borderless:!ae.value&&!e.is_new,modelValue:e.name,"onUpdate:modelValue":l=>e.name=l},null,8,["readonly","borderless","modelValue","onUpdate:modelValue"])]),(0,t._)("td",null,[(0,t.Wm)(r,{readonly:!ae.value&&!e.is_new,dense:"",borderless:!ae.value&&!e.is_new,standout:"",options:te,modelValue:e.unit,"onUpdate:modelValue":l=>e.unit=l},null,8,["readonly","borderless","modelValue","onUpdate:modelValue"])]),(0,t._)("td",null,[(0,t.Wm)(s,{onFocus:u[1]||(u[1]=e=>e.target.select()),type:"number",readonly:!ae.value&&!e.is_new,dense:"",standout:"",onChange:l=>e.total_amount?null:e.total_amount=0,borderless:!ae.value&&!e.is_new,modelValue:e.total_amount,"onUpdate:modelValue":l=>e.total_amount=l},null,8,["readonly","onChange","borderless","modelValue","onUpdate:modelValue"])]),(0,t._)("td",null,(0,o.zw)(e.today_ostatok),1),(0,t._)("td",null,[(0,t.Wm)(s,{onFocus:u[2]||(u[2]=e=>e.target.select()),type:"number",readonly:!ae.value&&!e.is_new,dense:"",standout:"",onChange:l=>e.price_per_unit?null:e.price_per_unit=0,borderless:!ae.value&&!e.is_new,modelValue:e.price_per_unit,"onUpdate:modelValue":l=>e.price_per_unit=l},null,8,["readonly","onChange","borderless","modelValue","onUpdate:modelValue"])]),(0,t._)("td",null,(0,o.zw)(e.total_price),1),0===a.value.dates?.length?((0,t.wg)(),(0,t.iD)("td",B,[(0,t.Wm)(_.Z,{onConfirm:e=>de(l)},null,8,["onConfirm"])])):(0,t.kq)("",!0)])))),128)),(0,t._)("tr",L,[$,F,(0,t._)("td",P,(0,o.zw)(a.value.total_items_price),1)])]),(0,t._)("div",Y,[(0,t._)("div",K,[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(O.value,((e,a)=>((0,t.wg)(),(0,t.iD)("table",T,[(0,t._)("tr",A,[(0,t._)("td",I,(0,o.zw)(e.is_new?e.date:new Date(e.date).toLocaleDateString()),1)]),E,((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(e.items,((a,d)=>((0,t.wg)(),(0,t.iD)("tr",{class:"table-row",key:d},[(0,t._)("td",null,[(0,t.Wm)(s,{type:"number",onFocus:u[3]||(u[3]=e=>e.target.select()),onChange:e=>a.plan_amount>N.value.find((e=>e.id===a.item)).today_ostatok?a.plan_amount=N.value.find((e=>e.id===a.item)).today_ostatok:null,dense:"",autofocus:e.is_new,standout:"",borderless:!e.is_new,modelValue:a.plan_amount,"onUpdate:modelValue":e=>a.plan_amount=e},null,8,["onChange","autofocus","borderless","modelValue","onUpdate:modelValue"])]),(0,n.SU)(l).user.role.is_subworker&&(new Date).toLocaleDateString()===new Date(e.date).toLocaleDateString()&&(new Date).toLocaleTimeString()>="10:00:00"?((0,t.wg)(),(0,t.iD)("td",G,[(0,t.Wm)(s,{type:"number",onFocus:u[4]||(u[4]=e=>e.target.select()),onChange:e=>a.fact_amount>N.value.find((e=>e.id===a.item)).today_ostatok?a.fact_amount=N.value.find((e=>e.id===a.item)).today_ostatok:null,dense:"",standout:"",modelValue:a.fact_amount,"onUpdate:modelValue":e=>a.fact_amount=e},null,8,["onChange","modelValue","onUpdate:modelValue"])])):((0,t.wg)(),(0,t.iD)("td",J,(0,o.zw)(a.fact_amount),1)),(0,t._)("td",null,(0,o.zw)(a.to_pay),1)])))),128))])))),256))])])]),0!==a.value.dates?.length||ae.value?(0,t.kq)("",!0):((0,t.wg)(),(0,t.j4)(d.Z,{key:1,class:"q-mb-md",label:"Добавить товар",color:"primary",onClick:ie})),M,!ae.value&&0===a.value.dates?.length&&N.value.length>0&&X.value?((0,t.wg)(),(0,t.j4)(d.Z,{key:2,disable:!ne.value,class:"q-mb-md",icon:"save",label:"Сохранить таблицу",color:"positive",onClick:ue},null,8,["disable"])):(0,t.kq)("",!0),ae.value||R.value?((0,t.wg)(),(0,t.j4)(d.Z,{key:3,class:"q-mb-md",label:"Обновить таблицу",disable:!ne.value,icon:"save",color:"positive",onClick:se},null,8,["disable"])):(0,t.kq)("",!0),(0,n.SU)(l).user.role.is_subworker?((0,t.wg)(),(0,t.j4)(ee,{key:4,"no-caps":"",unelevated:"",class:"q-mb-md",label:"Сохранить таблицу",icon:"save",color:"positive",onClick:se})):(0,t.kq)("",!0)])),_:1})}}};var O=a(9885),R=a(3119),X=a(6384),ee=a(8879),le=a(9984),ae=a.n(le);const te=N,oe=te;ae()(N,"components",{QPage:O.Z,QInput:R.Z,QSelect:X.Z,QBtn:ee.Z})}}]);