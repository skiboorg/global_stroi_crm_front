"use strict";(globalThis["webpackChunkglobal_stroi_crm_front"]=globalThis["webpackChunkglobal_stroi_crm_front"]||[]).push([[816],{8550:(e,l,t)=>{t.d(l,{Z:()=>r});var a=t(9835);const o={__name:"AddButton",props:["label","icon","loading","color"],setup(e){return(l,t)=>{const o=(0,a.up)("q-btn");return l.auth.user.role?.permission?.can_add?((0,a.wg)(),(0,a.j4)(o,{key:0,"no-caps":"",unelevated:"",loading:e.loading,color:e.color?e.color:"primary",label:e.label,icon:e.icon?e.icon:"add"},null,8,["loading","color","label","icon"])):(0,a.kq)("",!0)}}};var n=t(8879),s=t(9984),u=t.n(s);const d=o,r=d;u()(o,"components",{QBtn:n.Z})},8203:(e,l,t)=>{t.d(l,{Z:()=>c});var a=t(9835);function o(e,l){const t=(0,a.up)("q-btn");return(0,a.wg)(),(0,a.j4)(t,{"no-caps":"",outline:"",color:"primary",label:"Назад",icon:"arrow_back",class:"q-mr-md",onClick:l[0]||(l[0]=l=>e.$router.back())})}var n=t(1639),s=t(8879),u=t(9984),d=t.n(u);const r={},i=(0,n.Z)(r,[["render",o]]),c=i;d()(r,"components",{QBtn:s.Z})},8227:(e,l,t)=>{t.d(l,{Z:()=>b});var a=t(9835),o=t(499);const n={__name:"DeleteButton",props:["label","icon","loading","color"],emits:["confirm"],setup(e,{emit:l}){const t=(0,o.iH)(!1);return(l,o)=>{const n=(0,a.up)("q-btn"),s=(0,a.up)("q-card-section"),u=(0,a.up)("q-card-actions"),d=(0,a.up)("q-card"),r=(0,a.up)("q-dialog"),i=(0,a.Q2)("close-popup");return(0,a.wg)(),(0,a.iD)(a.HY,null,[l.auth.user.role?.permission?.can_add?((0,a.wg)(),(0,a.j4)(n,{key:0,"no-caps":"",unelevated:"",dense:"",loading:e.loading,color:e.color?e.color:"negative",label:e.label,onClick:o[0]||(o[0]=e=>t.value=!0),icon:e.icon?e.icon:"delete"},null,8,["loading","color","label","icon"])):(0,a.kq)("",!0),(0,a.Wm)(r,{modelValue:t.value,"onUpdate:modelValue":o[2]||(o[2]=e=>t.value=e)},{default:(0,a.w5)((()=>[(0,a.Wm)(d,{style:{width:"300px","max-width":"100vw"}},{default:(0,a.w5)((()=>[(0,a.Wm)(s,{class:"text-center text-bold"},{default:(0,a.w5)((()=>[(0,a.Uk)(" Вы уверены? ")])),_:1}),(0,a.Wm)(u,{align:"center"},{default:(0,a.w5)((()=>[(0,a.wy)((0,a.Wm)(n,{color:"negative",unelevated:"","no-caps":"",label:"Да",onClick:o[1]||(o[1]=e=>l.$emit("confirm"))},null,512),[[i]]),(0,a.wy)((0,a.Wm)(n,{color:"positive",unelevated:"","no-caps":"",label:"Нет"},null,512),[[i]])])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}};var s=t(8879),u=t(2074),d=t(4458),r=t(3190),i=t(1821),c=t(2146),_=t(9984),p=t.n(_);const m=n,b=m;p()(n,"components",{QBtn:s.Z,QDialog:u.Z,QCard:d.Z,QCardSection:r.Z,QCardActions:i.Z}),p()(n,"directives",{ClosePopup:c.Z})},1862:(e,l,t)=>{t.d(l,{Z:()=>r});var a=t(9835);const o={__name:"EditButton",props:["label","icon","color"],setup(e){return(l,t)=>{const o=(0,a.up)("q-btn");return l.auth.user.role?.permission?.can_edit?((0,a.wg)(),(0,a.j4)(o,{key:0,"no-caps":"",unelevated:"",color:e.color,label:e.label,icon:e.icon?e.icon:"edit"},null,8,["color","label","icon"])):(0,a.kq)("",!0)}}};var n=t(8879),s=t(9984),u=t.n(s);const d=o,r=d;u()(o,"components",{QBtn:n.Z})},1816:(e,l,t)=>{t.r(l),t.d(l,{default:()=>de});t(2879);var a=t(9835),o=t(6970),n=t(499),s=t(1569),u=t(8339),d=t(8550),r=t(1862),i=t(6928),c=t(8203),_=t(8227);const p={key:0,class:"q-mb-md"},m={class:"flex items-center justify-between q-mb-md"},b={class:"no-margin text-h6 text-bold"},v=(0,a._)("p",{class:"text-h6 text-bold"},"Общие данные",-1),w={class:"info-table q-mb-lg"},g=(0,a._)("td",null,[(0,a._)("span",{class:"text-bold"},"Адрес ")],-1),k=(0,a._)("td",null,[(0,a._)("span",{class:"text-bold"},"Подрядчик ")],-1),y=(0,a._)("td",null,[(0,a._)("span",{class:"text-bold"},"Сумма договора ")],-1),f=(0,a._)("td",null,[(0,a._)("span",{class:"text-bold"},"Сумма аванса ")],-1),h=(0,a._)("td",null,[(0,a._)("span",{class:"text-bold"},"Выполнено работ ")],-1),q=(0,a._)("td",null,[(0,a._)("span",{class:"text-bold"},"Сумма к оплате ")],-1),x={class:"q-gutter-md q-mb-md"},D=(0,a._)("p",{class:"text-h6 text-bold"},"Расчет стоимости",-1),V={class:"object-tables-grid items-start no-wrap",style:{gap:"8px"}},C={class:"table q-mb-md"},Z={style:{height:"118px"},class:"table-head-row"},j=(0,a._)("td",{style:{width:"0px"}},"№",-1),U=(0,a._)("td",null,"Наименование",-1),z=(0,a._)("td",null,"Ед. изм",-1),W=(0,a._)("td",null,"Кол-во",-1),Q=(0,a._)("td",null,"Текущий остаток",-1),H=(0,a._)("td",null,"Цена",-1),S=(0,a._)("td",null,"Общая стоимость",-1),B={key:0},L={class:"text-center"},$={class:"text-center"},F={key:0},P={class:"table-row"},Y=(0,a._)("td",{colspan:"4"},null,-1),K=(0,a._)("td",{class:"text-bold"},"Итого",-1),T={class:"text-bold"},A={class:"table-wrapper"},I={class:"object-subtables-grid items-start no-wrap",style:{gap:"8px"}},E={class:"table"},G={class:"table-head-row"},J={colspan:"4"},M=(0,a._)("tr",{class:"table-subhead-row"},[(0,a._)("td",null,"План"),(0,a._)("td",null,"Факт"),(0,a._)("td",null,"Сумма к оплате")],-1),N={class:"text-center"},O={key:0},R={key:1,style:{"text-align":"center !important"}},X=(0,a._)("br",null,null,-1),ee={__name:"object",setup(e){const l=(0,i.t)(),t=(0,n.iH)({}),ee=(0,n.iH)([]),le=(0,n.iH)([]),te=(0,n.iH)(!1),ae=(0,n.iH)(!1),oe=(0,n.iH)({date:(new Date).toLocaleDateString(),total_done_work_percent:0,total_to_pay:0,items:[],is_new:!0}),ne=(0,u.yj)(),se=(0,n.iH)(!1),ue=["м.","шт","уп.","усл."];(0,a.wF)((async()=>{await de()}));const de=async()=>{const e=await(0,s.api)(`/api/catalog/object/${ne.params.id}?full=true`);t.value=e.data,ee.value=t.value.items,le.value=t.value.dates},re=(0,a.Fl)((()=>{let e=!0,l=!0;for(let t of ee.value){if(0===t.total_amount){e=!1;break}if(0===t.price_per_unit){l=!1;break}}return e&&l})),ie=async()=>{await s.api.post("/api/catalog/object/save_table",t.value);await de(),ae.value=!1},ce=async()=>{await s.api.post("/api/catalog/object/update_table",t.value);await de(),se.value=!1},_e=async e=>{ee.value[e].is_new?(console.log("new"),ee.value.splice(e,1)):(console.log("old"),await s.api.delete(`/api/catalog/object_item/${ee.value[e].id}`),await de())},pe=()=>{ae.value=!0,ee.value.push({is_new:!0,name:null,unit:null,total_amount:0,today_ostatok:0,price_per_unit:0,total_price:0})},me=()=>{for(let e of le.value)if(new Date(e.date).toLocaleDateString()===(new Date).toLocaleDateString())return;le.value.push(oe.value),te.value=!0;for(let e of ee.value)oe.value.items.push({plan_amount:0,fact_amount:0,done_work_percent:0,to_pay:0,item:e.id})};return(e,s)=>{const u=(0,a.up)("q-input"),i=(0,a.up)("q-select"),oe=(0,a.up)("q-btn"),ne=(0,a.up)("q-page");return(0,a.wg)(),(0,a.j4)(ne,{padding:""},{default:(0,a.w5)((()=>[t.value.id?((0,a.wg)(),(0,a.iD)("div",p,[(0,a._)("div",m,[(0,a.Wm)(c.Z),(0,a._)("p",b,"Объект ID:"+(0,o.zw)(t.value.id)+" - "+(0,o.zw)(t.value.name),1)]),v,(0,a._)("table",w,[(0,a._)("tr",null,[g,(0,a._)("td",null,(0,o.zw)(t.value.address),1)]),(0,a._)("tr",null,[k,(0,a._)("td",null,(0,o.zw)(t.value.subworker?.fio),1)]),(0,a._)("tr",null,[y,(0,a._)("td",null,(0,o.zw)(e.$filters.formatPrice(t.value.total))+" руб",1)]),(0,a._)("tr",null,[f,(0,a._)("td",null,(0,o.zw)(e.$filters.formatPrice(t.value.avans))+" руб",1)]),(0,a._)("tr",null,[h,(0,a._)("td",null,(0,o.zw)(t.value.procent_done)+" %",1)]),(0,a._)("tr",null,[q,(0,a._)("td",null,(0,o.zw)(e.$filters.formatPrice(t.value.to_pay))+" руб",1)])])])):(0,a.kq)("",!0),(0,a._)("div",x,[t.value.is_items_added&&t.value.items?.length>0&&!te.value?((0,a.wg)(),(0,a.j4)(r.Z,{key:0,class:"q-mb-md",label:"Редактировать таблицу",color:"warning",onClick:s[0]||(s[0]=e=>se.value=!0)})):(0,a.kq)("",!0),t.value.is_items_added&&t.value.items?.length>0&&!te.value&&!se.value?((0,a.wg)(),(0,a.j4)(d.Z,{key:1,class:"q-mb-md",label:"Добавить дату",color:"positive",onClick:me})):(0,a.kq)("",!0)]),D,(0,a._)("div",V,[(0,a._)("table",C,[(0,a._)("tr",Z,[j,U,z,W,Q,H,S,0===t.value.dates?.length?((0,a.wg)(),(0,a.iD)("td",B)):(0,a.kq)("",!0)]),((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(ee.value,((e,l)=>((0,a.wg)(),(0,a.iD)("tr",{class:"table-row",key:l},[(0,a._)("td",L,(0,o.zw)(l+1),1),(0,a._)("td",null,[(0,a.Wm)(u,{readonly:!se.value&&!e.is_new,dense:"",standout:"",borderless:!se.value&&!e.is_new,class:"input-no-center",modelValue:e.name,"onUpdate:modelValue":l=>e.name=l},null,8,["readonly","borderless","modelValue","onUpdate:modelValue"])]),(0,a._)("td",null,[(0,a.Wm)(i,{readonly:!se.value&&!e.is_new,dense:"",borderless:!se.value&&!e.is_new,class:"text-center",standout:"",options:ue,modelValue:e.unit,"onUpdate:modelValue":l=>e.unit=l},null,8,["readonly","borderless","modelValue","onUpdate:modelValue"])]),(0,a._)("td",null,[(0,a.Wm)(u,{onFocus:s[1]||(s[1]=e=>e.target.select()),type:"number",readonly:!se.value&&!e.is_new,dense:"",standout:"",class:"text-center",onChange:l=>e.total_amount?null:e.total_amount=0,borderless:!se.value&&!e.is_new,modelValue:e.total_amount,"onUpdate:modelValue":l=>e.total_amount=l},null,8,["readonly","onChange","borderless","modelValue","onUpdate:modelValue"])]),(0,a._)("td",$,(0,o.zw)(e.today_ostatok),1),(0,a._)("td",null,[(0,a.Wm)(u,{onFocus:s[2]||(s[2]=e=>e.target.select()),type:"number",readonly:!se.value&&!e.is_new,dense:"",standout:"",class:"text-center",onChange:l=>e.price_per_unit?null:e.price_per_unit=0,borderless:!se.value&&!e.is_new,modelValue:e.price_per_unit,"onUpdate:modelValue":l=>e.price_per_unit=l},null,8,["readonly","onChange","borderless","modelValue","onUpdate:modelValue"])]),(0,a._)("td",null,(0,o.zw)(e.total_price),1),0===t.value.dates?.length?((0,a.wg)(),(0,a.iD)("td",F,[(0,a.Wm)(_.Z,{onConfirm:e=>_e(l)},null,8,["onConfirm"])])):(0,a.kq)("",!0)])))),128)),(0,a._)("tr",P,[Y,K,(0,a._)("td",T,(0,o.zw)(t.value.total_items_price),1)])]),(0,a._)("div",A,[(0,a._)("div",I,[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(le.value,((e,t)=>((0,a.wg)(),(0,a.iD)("table",E,[(0,a._)("tr",G,[(0,a._)("td",J,(0,o.zw)(e.is_new?e.date:new Date(e.date).toLocaleDateString()),1)]),M,((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(e.items,((t,d)=>((0,a.wg)(),(0,a.iD)("tr",{class:"table-row",key:d},[(0,a._)("td",N,[(0,a.Wm)(u,{type:"number",class:"text-center",onFocus:s[3]||(s[3]=e=>e.target.select()),onChange:e=>t.plan_amount>ee.value.find((e=>e.id===t.item)).today_ostatok?t.plan_amount=ee.value.find((e=>e.id===t.item)).today_ostatok:null,dense:"",autofocus:e.is_new,standout:"",borderless:!e.is_new,modelValue:t.plan_amount,"onUpdate:modelValue":e=>t.plan_amount=e},null,8,["onChange","autofocus","borderless","modelValue","onUpdate:modelValue"])]),(0,n.SU)(l).user.role.is_subworker&&(new Date).toLocaleDateString()===new Date(e.date).toLocaleDateString()&&(new Date).toLocaleTimeString()>="10:00:00"?((0,a.wg)(),(0,a.iD)("td",O,[(0,a.Wm)(u,{class:"text-center",type:"number",onFocus:s[4]||(s[4]=e=>e.target.select()),onChange:e=>t.fact_amount>ee.value.find((e=>e.id===t.item)).today_ostatok?t.fact_amount=ee.value.find((e=>e.id===t.item)).today_ostatok:null,dense:"",standout:"",modelValue:t.fact_amount,"onUpdate:modelValue":e=>t.fact_amount=e},null,8,["onChange","modelValue","onUpdate:modelValue"])])):((0,a.wg)(),(0,a.iD)("td",R,(0,o.zw)(t.fact_amount),1)),(0,a._)("td",null,(0,o.zw)(t.to_pay),1)])))),128))])))),256))])])]),0!==t.value.dates?.length||se.value?(0,a.kq)("",!0):((0,a.wg)(),(0,a.j4)(d.Z,{key:1,class:"q-mb-md",label:"Добавить товар",color:"primary",onClick:pe})),X,!se.value&&0===t.value.dates?.length&&ee.value.length>0&&ae.value?((0,a.wg)(),(0,a.j4)(d.Z,{key:2,disable:!re.value,class:"q-mb-md",icon:"save",label:"Сохранить таблицу",color:"positive",onClick:ie},null,8,["disable"])):(0,a.kq)("",!0),se.value||te.value?((0,a.wg)(),(0,a.j4)(d.Z,{key:3,class:"q-mb-md",label:"Обновить таблицу",disable:!re.value,icon:"save",color:"positive",onClick:ce},null,8,["disable"])):(0,a.kq)("",!0),(0,n.SU)(l).user.role.is_subworker?((0,a.wg)(),(0,a.j4)(oe,{key:4,"no-caps":"",unelevated:"",class:"q-mb-md",label:"Сохранить таблицу",icon:"save",color:"positive",onClick:ce})):(0,a.kq)("",!0)])),_:1})}}};var le=t(9885),te=t(3119),ae=t(6384),oe=t(8879),ne=t(9984),se=t.n(ne);const ue=ee,de=ue;se()(ee,"components",{QPage:le.Z,QInput:te.Z,QSelect:ae.Z,QBtn:oe.Z})}}]);